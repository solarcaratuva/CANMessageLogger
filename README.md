# CAN Message Logger

This program is for logging, filtering, and analyzing recorded or live CAN messages. It is a one-stop-shop for CAN message based debugging and analysis.

## Installation

1. Clone the GitHub repo.
2. Navigate to the root directory of the cloned repo (`CANMessageLogger`)
3. Create a virtual environment via `python -m venv venv`
4. Activate the virtual environment by running the command `.\.venv\Scripts\activate` (on Mac instead run `source ./venv/bin/activate`). 
5. Run the command `pip install -r requirements.txt` to install all dependencies
6. Continue to "Starting the program" for instructions on starting the server.

## Starting the program

Run the following commands in a command prompt in the directory of this project: 

1. Activate the virtual environment (should be activated already, but you can reference step 4 in "Installation")
2. When launching the program, settings for the server can either be input directly via command line flags, or through a startup UI.
    * To start the program with the startup UI run the command `py .\src\main.py`. See "Navigating the user interface" for next steps.
    * To start the server directly with command line flags run the command `py .\src\main.py [data source] [flags...]`; if `py` isn't recognized, try `python` or `python3`. Specifying the data source is a required positional argument, while flags are largely optional and can be in any order. 

**Data Source**

User must include the data source type that will be used to set up the database. The currently available data source options are:

1. `pastlog`: Reads in a .txt file that contains stream of CAN messages. Requires `--inputFile` flag.
2. `mock_livelog`: Simulates reading in live data from a .txt file that contains stream of CAN messages. Requires `--inputFile` flag.
3. `livelog`: Reads live log data from an ST-Link (must be physically attached to a board on the car)
4. `db`: Reads in a .db or .sql file that has been generated by this program.

**Flags**

`-i`, `--inputFile`: Specifies path of input file, must be followed by logfile path  
`-o`, `--outputDB`: Specifies the name of the output DB, name is autogenerated if not specified
`-b`, `--set_dbc_branch`: Specifies which DBC branch to use, defaults to `main`

## Navigating the user interface

### Startup UI

1. The user interface will be launched by default upon startup by running `py .\src\main.py` with no flags. If flags are included, the startup options UI will not be launched. 
2. The startup options UI contains options to modify the same settings as set by the flags, including: 
    * Log Type (pastlog, livelog, mock_livelog, db, radio)
    * Input File
    * Output File/DB
    * DBC Branch.
3. Selecting an input file is required for logTypes of pastlog, mock_livelog, and db. To select a file, click the Choose File button within the input file dialog box to launch a standard file explorer window.
4. For the rest of the desired inputs, select the radio style buttons for each option, and press the `Launch App` button to start the main server. The browser will automatically redirect to the main application in the same tab.

### Main UI

There are 3 views, selected by clicking on them on the taskbar on the top of the page
- **Debug Dashboard** - Shows the current state of any selected CAN Messages. Select which messages to show by using the checkboxes on the right of the screen. 
- **Graph View** - Shows selected CAN message signals versus time. Select which message signals to show by using the checkboxes on the right of the screen. 
- **Alerts Manager** - Create custom alerts to flash a banner when a certain message signal is a certain value. This page allows you to set and delete alerts, and view the log of when they have been triggered. Faults will always trigger an alert. 

## Overview of the Backend (for New Developers)

### Startup Flow

The program supports two startup modes:

1. **UI Mode (default)**: Running `py .\src\main.py` with no arguments launches a setup server (`startup_server.py`) on port 5499. This opens a browser to a configuration UI where users select options. Upon clicking "Launch App", the setup server validates inputs, starts the main server in a new thread, and redirects the browser to the main application on port 5500.

2. **CLI Mode**: Running with command-line arguments (e.g., `py .\src\main.py pastlog -i logfile.txt`) bypasses the UI and directly starts the main server with the provided configuration.

### Data Processing

The backend uses a Producer-Consumer software pattern to produce CAN message entries from a given data source, and consume them into a central database SQLite file (CDB). The *consumer* module and various *producer* modules are kept in the `\src\backend\input` directory.

The backend also uses 2 custom objects to streamline this process: 

- To handle the processing of CAN messages, the backend uses the custom `CanMessage` object to represent a CAN Message.
- Anytime the program wants to interact with the CDB, it needs to use a `DbConnection` object that represents a connection from the code to the CDB, allowing the code to query, insert, etc. into the CDB in a thread safe manner. 

The backend flow of data is as follows: 

1. The user includes a data source (`pastlog`, `mock_livelog`, etc.) when running the program. Based on the data source's type, the corresponding function from a producer module in `\src\backend\input` is called in `main.py` and provided with the data source path / location.
2. The producer function will then process the CAN messages from the data source and push them as a `tuple` into `queue`, which is a static queue that is shared between the `consumer` module and the various producer modules. 
3. Then a function from the `consumer` module will pop `tuples` from `queue`, then process the `tuple` and insert it into the CDB. 
