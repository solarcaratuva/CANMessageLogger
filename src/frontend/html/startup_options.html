<head>
    <meta charset="utf-8"/>
    <title>Startup Options</title>
    <link rel="stylesheet" href="/static/style/startup_options.css">
</head>
<body>
    <h1>Configure & Launch</h1>
    <form method="POST" action="/start">
    <fieldset>
        <legend>Log Type</legend>
        <div class="radio-group">
            <div class="radio-option">
                <input type="radio" name="logType" id="pastlog" value="pastlog" onchange="updateInputFileState()" required>
                <label for="pastlog">pastlog</label>
            </div>
            <div class="radio-option">
                <input type="radio" name="logType" id="livelog" value="livelog" onchange="updateInputFileState()">
                <label for="livelog">livelog</label>
            </div>
            <div class="radio-option">
                <input type="radio" name="logType" id="mock_livelog" value="mock_livelog" onchange="updateInputFileState()">
                <label for="mock_livelog">mock_livelog</label>
            </div>
            <div class="radio-option">
                <input type="radio" name="logType" id="db" value="db" onchange="updateInputFileState()">
                <label for="db">db</label>
            </div>
            <div class="radio-option">
                <input type="radio" name="logType" id="radio" value="radio" onchange="updateInputFileState()">
                <label for="radio">radio</label>
            </div>
        </div>
        <small>Choose the data source.</small>
    </fieldset>

    <fieldset id="inputFileFieldset" style="display:none;">
        <label for="inputFile">Input File <span id="inputFileRequiredLabel" style="color:#c00;">(required)</span></label>
        <input type="text" id="inputFile" name="inputFile" placeholder="e.g. ./logs/sample.log" />
        <div id="inputFileError" class="error">Input file must end with .log, .txt, or .db</div>
        <small>Required for pastlog/mock_livelog (.log/.txt) and db (.db).</small>
    </fieldset>

    <fieldset>
        <label for="outputDB">Output DB (optional)</label>
        <input type="text" id="outputDB" name="outputDB" placeholder="./CANDatabases/can_database_X.db" />
        <div id="outputDBError" class="error">Output DB must end with .db</div>
        <small>If omitted, a timestamped DB will be created.</small>
    </fieldset>

    <fieldset>
        <legend>DBC Branch</legend>
        <div class="radio-group">
            <div class="radio-option">
                <input type="radio" name="set_dbc_branch" id="main" value="main" checked>
                <label for="main">main</label>
            </div>
            <div class="radio-option">
                <input type="radio" name="set_dbc_branch" id="dev" value="dev">
                <label for="dev">dev</label>
            </div>
            <div class="radio-option">
                <input type="radio" name="set_dbc_branch" id="testing" value="testing">
                <label for="testing">testing</label>
            </div>
        </div>
    </fieldset>

    <fieldset id="hardwareStatusFieldset" style="display: none;">
        <legend>Hardware Status</legend>
        <div id="hardwareStatus" style="padding: 0.5rem; border-radius: 4px; font-weight: 600;">
            Checking hardware...
        </div>
    </fieldset>

    <button type="button" onclick="handleFormSubmit()">Launch App</button>
    </form>

    <script>
    async function validateForm() {
        let isValid = true;
        
        // Validate input file if visible and has content
        const inputFileFieldset = document.getElementById('inputFileFieldset');
        const inputFile = document.getElementById('inputFile');
        const inputFileError = document.getElementById('inputFileError');
        const logTypeRadio = document.querySelector('input[name="logType"]:checked');
        const logType = logTypeRadio ? logTypeRadio.value : '';
        
        if (inputFileFieldset.style.display !== 'none' && inputFile.value.trim()) {
            const filePath = inputFile.value.trim();
            
            try {
                const response = await fetch('/validate-file', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        filePath: filePath,
                        logType: logType 
                    })
                });
                
                const result = await response.json();
                
                if (!result.valid) {
                    inputFileError.innerHTML = result.message;
                    inputFileError.style.display = 'block';
                    isValid = false;
                } else {
                    inputFileError.style.display = 'none';
                }
            } catch (error) {
                inputFileError.innerHTML = 'Could not validate file';
                inputFileError.style.display = 'block';
                isValid = false;
            }
        } else {
            inputFileError.style.display = 'none';
        }
        
        // Validate output DB if provided
        const outputDB = document.getElementById('outputDB');
        const outputDBError = document.getElementById('outputDBError');
        
        if (outputDB.value.trim()) {
            const outputFileName = outputDB.value.trim().toLowerCase();
            if (!outputFileName.endsWith('.db')) {
                outputDBError.style.display = 'block';
                isValid = false;
            } else {
                outputDBError.style.display = 'none';
            }
        } else {
            outputDBError.style.display = 'none';
        }
        
        return isValid;
    }

    async function handleFormSubmit() {
        const isValid = await validateForm();
        if (isValid) {
            document.querySelector('form').submit();
        }
    }

    function updateInputFileState() {
        const logTypeRadio = document.querySelector('input[name="logType"]:checked');
        const logType = logTypeRadio ? logTypeRadio.value : '';
        const inputFileFieldset = document.getElementById('inputFileFieldset');
        const inputFile = document.getElementById('inputFile');
        const requiredLabel = document.getElementById('inputFileRequiredLabel');
        const inputFileError = document.getElementById('inputFileError');
        const hardwareStatusFieldset = document.getElementById('hardwareStatusFieldset');
        const requiredTypes = ['pastlog', 'db', 'mock_livelog'];
        
        if (requiredTypes.includes(logType)) {
            inputFileFieldset.style.display = '';
            inputFile.required = true;
            requiredLabel.style.display = '';
        } else {
            inputFileFieldset.style.display = 'none';
            inputFile.required = false;
            requiredLabel.style.display = 'none';
            inputFile.value = '';
            inputFileError.style.display = 'none';
        }
        
        // Show hardware status for hardware-dependent modes
        if (logType === 'livelog' || logType === 'radio') {
            hardwareStatusFieldset.style.display = '';
            checkHardwareStatus(logType);
        } else {
            hardwareStatusFieldset.style.display = 'none';
        }
    }
    
    async function checkHardwareStatus(logType) {
        const statusDiv = document.getElementById('hardwareStatus');
        statusDiv.innerHTML = 'Checking hardware...';
        statusDiv.style.backgroundColor = '#f0f0f0';
        statusDiv.style.color = '#333';
        
        try {
            const response = await fetch('/validate-hardware', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ logType: logType })
            });
            
            const result = await response.json();
            
            if (result.valid) {
                statusDiv.innerHTML = `${result.message}`;
                statusDiv.style.backgroundColor = '#e8f5e8';
                statusDiv.style.color = '#2e7d32';
            } else {
                statusDiv.innerHTML = `${result.message}`;
                statusDiv.style.backgroundColor = '#ffebee';
                statusDiv.style.color = '#d32f2f';
            }
        } catch (error) {
            statusDiv.innerHTML = 'Could not check hardware status';
            statusDiv.style.backgroundColor = '#ffebee';
            statusDiv.style.color = '#d32f2f';
        }
    }

    
    document.addEventListener('DOMContentLoaded', updateInputFileState);
    </script>
</body>
